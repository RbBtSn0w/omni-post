name: Dependency Security Scan

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    # Weekly on Monday at 9:00 UTC (17:00 Beijing Time)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      fail-on-severity:
        description: 'Fail on vulnerability severity level (low, moderate, high, critical)'
        required: false
        default: 'high'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
  pull_request:
    paths:
      - 'apps/backend/pyproject.toml'
      - 'apps/backend/requirements.txt'
      - 'apps/frontend/package.json'
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  python-dependencies:
    name: Python Dependencies Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: apps/backend/pyproject.toml

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-3.10-deps-${{ hashFiles('apps/backend/pyproject.toml', 'apps/backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-3.10-

    - name: Upgrade pip and install dependencies
      working-directory: apps/backend
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pip-audit

    - name: List installed packages
      id: list-packages
      working-directory: apps/backend
      run: |
        echo "=== Installed Python Packages ===" >> $GITHUB_STEP_SUMMARY
        pip list >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Check for outdated packages
      id: outdated
      working-directory: apps/backend
      run: |
        echo "=== Outdated Python Packages ===" >> $GITHUB_STEP_SUMMARY
        pip list --outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Run pip-audit security scan
      id: audit
      working-directory: apps/backend
      run: |
        echo "## ðŸ”’ Python Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine severity threshold
        SEVERITY_THRESHOLD="${{ github.event.inputs.fail-on-severity || 'high' }}"
        
        # Run pip-audit and capture results
        if pip-audit --format json --output audit_report.json --progress-spinner=off; then
          echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
        else
          # Check if we have valid JSON output
          if [ -s audit_report.json ] && jq empty audit_report.json 2>/dev/null; then
            # Display markdown summary
            pip-audit --format markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count vulnerabilities by severity
            vuln_count=$(jq '[.dependencies[] | select(.vulns | length > 0)] | length' audit_report.json 2>/dev/null || echo "0")
            
            if [ "$vuln_count" -gt "0" ]; then
              echo "âš ï¸ Found $vuln_count package(s) with vulnerabilities" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              echo "VULN_COUNT=$vuln_count" >> $GITHUB_OUTPUT
              
              # Fail based on severity threshold
              if [ "$SEVERITY_THRESHOLD" == "high" ] || [ "$SEVERITY_THRESHOLD" == "critical" ]; then
                # Only fail on high/critical
                high_crit_count=$(jq '[.dependencies[].vulns[] | select(.fix_versions != null)] | length' audit_report.json 2>/dev/null || echo "0")
                if [ "$high_crit_count" -gt "0" ]; then
                  exit 1
                fi
              else
                # Fail on any vulnerability
                exit 1
              fi
            else
              echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Error running pip-audit or invalid JSON output" >> $GITHUB_STEP_SUMMARY
            echo "VULNERABILITIES_FOUND=error" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Upload Python audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: python-dependency-audit-report
        path: apps/backend/audit_report.json
        retention-days: 90
        if-no-files-found: ignore

  npm-dependencies:
    name: NPM Dependencies Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      id: npm_audit
      run: |
        echo "## ðŸ”’ NPM Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine audit level (default: high for scheduled/PR, configurable for manual)
        AUDIT_LEVEL="${{ github.event.inputs.fail-on-severity || 'high' }}"
        
        # Run npm audit with appropriate level
        set +e
        npm audit --audit-level=$AUDIT_LEVEL --production --json > npm_audit.json
        audit_exit_code=$?
        set -e
        
        if [ $audit_exit_code -eq 0 ]; then
          echo "âœ… No $AUDIT_LEVEL or higher severity vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
        else
          # Check if output is valid JSON
          if [ -s npm_audit.json ] && jq empty npm_audit.json 2>/dev/null; then
            # Parse vulnerability counts
            critical=$(jq '.metadata.vulnerabilities.critical // 0' npm_audit.json 2>/dev/null || echo "0")
            high=$(jq '.metadata.vulnerabilities.high // 0' npm_audit.json 2>/dev/null || echo "0")
            moderate=$(jq '.metadata.vulnerabilities.moderate // 0' npm_audit.json 2>/dev/null || echo "0")
            low=$(jq '.metadata.vulnerabilities.low // 0' npm_audit.json 2>/dev/null || echo "0")
            
            echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Critical: $critical" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $high" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Moderate: $moderate" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¢ Low: $low" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show detailed audit output
            npm audit --audit-level=$AUDIT_LEVEL --production >> $GITHUB_STEP_SUMMARY 2>&1 || true
            
            # Determine if we should fail based on severity
            should_fail=false
            case "$AUDIT_LEVEL" in
              "critical")
                [ "$critical" -gt "0" ] && should_fail=true
                ;;
              "high")
                [ "$critical" -gt "0" ] || [ "$high" -gt "0" ] && should_fail=true
                ;;
              "moderate")
                [ "$critical" -gt "0" ] || [ "$high" -gt "0" ] || [ "$moderate" -gt "0" ] && should_fail=true
                ;;
              "low")
                [ "$critical" -gt "0" ] || [ "$high" -gt "0" ] || [ "$moderate" -gt "0" ] || [ "$low" -gt "0" ] && should_fail=true
                ;;
            esac
            
            if [ "$should_fail" = true ]; then
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âœ… No vulnerabilities at configured threshold ($AUDIT_LEVEL)" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ npm audit failed or returned invalid output (exit code: $audit_exit_code)" >> $GITHUB_STEP_SUMMARY
            if [ -s npm_audit.json ]; then
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              head -20 npm_audit.json >> $GITHUB_STEP_SUMMARY 2>&1 || true
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "VULNERABILITIES_FOUND=error" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Upload NPM audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: npm-dependency-audit-report
        path: npm_audit.json
        retention-days: 90
        if-no-files-found: ignore

  create-issue:
    name: Create Issue on Vulnerability Detection
    runs-on: ubuntu-latest
    needs: [python-dependencies, npm-dependencies]
    if: failure() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
    - name: Create or update security issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const date = new Date().toISOString().split('T')[0];
          
          // Check for existing open security issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ðŸ”’ security,ðŸ“¦ dependencies,automated'
          });
          
          const commentBody = `ðŸ”„ **New vulnerabilities detected**\n\nDate: ${date}\nWorkflow Run: ${runUrl}\n\nPlease review the latest dependency scan results and update affected packages.`;
          
          if (issues.data.length > 0) {
            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: commentBody
            });
            console.log(`Added comment to existing issue #${issues.data[0].number}`);
          } else {
            // Create new issue
            const issueBody = `## ðŸš¨ Security Alert: Dependency Vulnerabilities Detected\n\nAutomated dependency scan has detected security vulnerabilities in project dependencies.\n\n### ðŸ“‹ Action Required\n\n1. Review the [workflow run details](${runUrl})\n2. Download and analyze the audit reports (artifacts)\n3. Update affected dependencies to patched versions\n4. Run tests to ensure compatibility\n5. Deploy updates promptly\n\n### ðŸ”§ Remediation Steps\n\n**For Python Dependencies:**\n\`\`\`bash\n# Review vulnerabilities\ncd apps/backend\npip-audit\n\n# Update specific packages\npip install --upgrade <package-name>\n\n# Update requirements\npip freeze > requirements.txt\n\`\`\`\n\n**For NPM Dependencies:**\n\`\`\`bash\n# Auto-fix compatible issues\nnpm audit fix\n\n# For breaking changes, manual review required\nnpm audit fix --force  # Use with caution\n\n# Update package-lock.json\nnpm install\n\`\`\`\n\n### âš ï¸ Important Notes\n\n- Review changelogs before upgrading major versions\n- Test thoroughly in development environment\n- Consider security vs. stability tradeoffs\n- Document any packages that cannot be upgraded\n\n---\n*This issue was automatically created by the dependency scan workflow on ${date}.*`;
            
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Dependency Vulnerabilities Detected - ${date}`,
              body: issueBody,
              labels: ['ðŸ”’ security', 'ðŸ“¦ dependencies', 'automated'],
              assignees: ['RbBtSn0w']
            });
            console.log(`Created new issue #${newIssue.data.number}`);
          }

  summary:
    name: Dependency Scan Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs: [python-dependencies, npm-dependencies]

    steps:
    - name: Generate summary report
      run: |
        echo "## ðŸ“‹ Dependency Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Scans Completed" >> $GITHUB_STEP_SUMMARY
        echo "- Python dependencies (pip-audit)" >> $GITHUB_STEP_SUMMARY
        echo "- NPM dependencies (npm audit)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Python:** ${{ needs.python-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **NPM:** ${{ needs.npm-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review detailed scan results above" >> $GITHUB_STEP_SUMMARY
        echo "2. Download audit reports from artifacts" >> $GITHUB_STEP_SUMMARY
        echo "3. Prioritize critical and high severity issues" >> $GITHUB_STEP_SUMMARY
        echo "4. Update dependencies and test changes" >> $GITHUB_STEP_SUMMARY
        echo "5. Monitor for new vulnerabilities weekly" >> $GITHUB_STEP_SUMMARY
