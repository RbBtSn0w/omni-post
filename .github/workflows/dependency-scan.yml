name: Dependency Security Scan

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    # Weekly on Monday at 9:00 UTC (17:00 Beijing Time)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      severity-threshold:
        description: 'Fail on vulnerabilities at or above this severity (low, moderate, high, critical)'
        required: false
        default: 'high'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
  pull_request:
    paths:
      - 'apps/backend/requirements.txt'
      - 'apps/backend/pyproject.toml'
      - 'package.json'
      - 'package-lock.json'
      - 'apps/frontend/package.json'

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  python-dependencies:
    name: Python Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: apps/backend/pyproject.toml

    - name: Install dependencies and audit tools
      working-directory: apps/backend
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pip-audit

    - name: List installed packages
      id: list-packages
      working-directory: apps/backend
      run: |
        echo "## ğŸ“¦ Installed Python Packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        pip list >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Check for outdated packages
      id: outdated
      working-directory: apps/backend
      run: |
        echo "## ğŸ“‹ Outdated Python Packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if pip list --outdated | grep -v '^Package' | grep -v '^---' | wc -l | grep -q '^0$'; then
          echo "âœ… All packages are up to date" >> $GITHUB_STEP_SUMMARY
        else
          echo '```' >> $GITHUB_STEP_SUMMARY
          pip list --outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Run pip-audit security scan
      id: pip-audit
      working-directory: apps/backend
      run: |
        echo "## ğŸ”’ Python Security Audit (pip-audit)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run pip-audit with JSON output for parsing
        if pip-audit --format json --output audit_report.json --progress-spinner=off; then
          echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
          exit 0
        else
          # pip-audit found vulnerabilities or encountered an error
          if [ -s audit_report.json ] && jq empty audit_report.json 2>/dev/null; then
            # Valid JSON exists - parse and display results
            echo "### Vulnerability Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            pip-audit --format markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count vulnerabilities by severity
            vuln_count=$(jq '[.dependencies[] | select(.vulns | length > 0)] | length' audit_report.json 2>/dev/null || echo "0")
            
            if [ "$vuln_count" -gt "0" ]; then
              echo "âš ï¸ Found vulnerabilities in $vuln_count package(s)" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              echo "VULN_COUNT=$vuln_count" >> $GITHUB_OUTPUT
              
              # Determine threshold (default to 'high' for PR/push, use input for workflow_dispatch)
              threshold="${{ github.event.inputs.severity-threshold || 'high' }}"
              echo "Severity threshold: $threshold" >> $GITHUB_STEP_SUMMARY
              
              # For now, fail on any vulnerability (can be made more granular later)
              exit 1
            else
              echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "âš ï¸ pip-audit encountered an error or returned invalid output" >> $GITHUB_STEP_SUMMARY
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

    - name: Upload Python audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: python-dependency-audit-report
        path: apps/backend/audit_report.json
        retention-days: 90

  npm-dependencies:
    name: NPM Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: List installed packages
      run: |
        echo "## ğŸ“¦ Installed NPM Packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Root workspace" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        npm list --depth=0 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Check for outdated packages
      run: |
        echo "## ğŸ“‹ Outdated NPM Packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        npm outdated 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || echo "All packages are up to date" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Run npm audit
      id: npm-audit
      run: |
        echo "## ğŸ”’ NPM Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine audit level threshold
        threshold="${{ github.event.inputs.severity-threshold || 'high' }}"
        echo "Audit level threshold: $threshold" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run npm audit with JSON output
        set +e
        npm audit --audit-level=$threshold --production --json > npm_audit.json 2>&1
        audit_exit_code=$?
        set -e
        
        if [ $audit_exit_code -eq 0 ]; then
          echo "âœ… No $threshold or higher severity vulnerabilities found in production dependencies" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
          exit 0
        else
          # Check if output is valid JSON
          if [ -s npm_audit.json ] && jq empty npm_audit.json 2>/dev/null; then
            # Parse vulnerability counts
            critical=$(jq '.metadata.vulnerabilities.critical // 0' npm_audit.json 2>/dev/null || echo "0")
            high=$(jq '.metadata.vulnerabilities.high // 0' npm_audit.json 2>/dev/null || echo "0")
            moderate=$(jq '.metadata.vulnerabilities.moderate // 0' npm_audit.json 2>/dev/null || echo "0")
            low=$(jq '.metadata.vulnerabilities.low // 0' npm_audit.json 2>/dev/null || echo "0")
            
            total=$((critical + high + moderate + low))
            
            if [ "$total" -gt "0" ]; then
              echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Critical | $critical |" >> $GITHUB_STEP_SUMMARY
              echo "| High | $high |" >> $GITHUB_STEP_SUMMARY
              echo "| Moderate | $moderate |" >> $GITHUB_STEP_SUMMARY
              echo "| Low | $low |" >> $GITHUB_STEP_SUMMARY
              echo "| **Total** | **$total** |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Show detailed audit output
              echo "### Detailed Audit Output" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              npm audit --audit-level=$threshold --production 2>&1 | head -100 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              echo "VULN_COUNT=$total" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âœ… No vulnerabilities found at threshold level" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "âš ï¸ npm audit failed or returned invalid output (exit code: $audit_exit_code)" >> $GITHUB_STEP_SUMMARY
            if [ -s npm_audit.json ]; then
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -20 npm_audit.json >> $GITHUB_STEP_SUMMARY 2>&1 || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            # Don't fail on audit errors
            exit 0
          fi
        fi

    - name: Upload NPM audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: npm-dependency-audit-report
        path: npm_audit.json
        retention-days: 90

  create-issue-if-vulnerable:
    name: Create Issue on Vulnerabilities
    runs-on: ubuntu-latest
    needs: [python-dependencies, npm-dependencies]
    if: failure() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
    - name: Create or update security issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const date = new Date().toISOString().split('T')[0];
          
          // Check for existing open security issues
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ğŸ”’ security,ğŸ“¦ dependencies,automated'
          });
          
          if (existingIssues.data.length > 0) {
            // Update existing issue with a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssues.data[0].number,
              body: `ğŸ”„ **New vulnerabilities detected**\n\n**Date:** ${date}\n**Workflow Run:** ${runUrl}\n\nPlease review the latest dependency scan results.`
            });
            console.log(`Updated existing issue #${existingIssues.data[0].number}`);
          } else {
            // Create new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Dependency Vulnerabilities Detected - ${date}`,
              body: `## ğŸ”’ Security Alert\n\nAutomated dependency scan has detected security vulnerabilities in project dependencies.\n\n### ğŸ“‹ Action Required\n\n1. Review the [workflow run details](${runUrl})\n2. Download and examine the security audit reports (artifacts)\n3. Update affected dependencies to patched versions\n4. Run tests to ensure compatibility\n5. Deploy the fixes\n\n### ğŸ› ï¸ Remediation Steps\n\n**For Python vulnerabilities:**\n\`\`\`bash\ncd apps/backend\npip-audit  # Review vulnerabilities\npip install --upgrade <package-name>  # Upgrade specific packages\npip freeze > requirements.txt  # Update lockfile if needed\n\`\`\`\n\n**For NPM vulnerabilities:**\n\`\`\`bash\nnpm audit  # Review vulnerabilities\nnpm audit fix  # Auto-fix compatible issues\nnpm audit fix --force  # Force fixes (may introduce breaking changes)\n\`\`\`\n\n### â„¹ï¸ Scan Configuration\n\n- **Trigger:** ${context.eventName}\n- **Severity Threshold:** High and Critical\n- **Scope:** Production dependencies\n\n---\n*This issue was automatically created by the dependency scan workflow. Close this issue once all vulnerabilities are resolved.*`,
              labels: ['ğŸ”’ security', 'ğŸ“¦ dependencies', 'automated'],
              assignees: ['RbBtSn0w']
            });
            console.log(`Created new issue #${issue.data.number}`);
          }

  summary:
    name: Scan Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs: [python-dependencies, npm-dependencies]

    steps:
    - name: Generate summary
      run: |
        echo "## ğŸ“Š Dependency Scan Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Scans Performed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Python dependencies (pip-audit)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… NPM dependencies (npm audit)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Outdated packages check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Python:** ${{ needs.python-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **NPM:** ${{ needs.npm-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Review the job outputs and artifacts for detailed vulnerability reports." >> $GITHUB_STEP_SUMMARY
