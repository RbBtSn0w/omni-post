name: Dependency Security Scan

# Consolidated dependency scanning for Python and NPM packages
# Combines pip-audit and npm audit with clear severity thresholds

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  # Run on PRs that modify dependency files
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/pyproject.toml'
      - 'apps/backend/requirements.txt'
      - 'package.json'
      - 'package-lock.json'
      - 'apps/frontend/package.json'
      - '.github/workflows/dependency-scan.yml'
  # Weekly schedule
  schedule:
    - cron: '0 9 * * 1'  # Monday at 9:00 UTC (17:00 Beijing Time)
  # Manual trigger
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  python-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python environment
        uses: ./.github/actions/setup-python
        with:
          python-version: '3.10'
          install-deps: 'true'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        id: pip-audit
        working-directory: apps/backend
        run: |
          echo "## ðŸ”’ Python Dependency Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run pip-audit with JSON output
          set +e
          pip-audit --format json --output audit-report.json --progress-spinner=off
          audit_exit=$?
          set -e
          
          if [ $audit_exit -eq 0 ]; then
            echo "âœ… No vulnerabilities found in Python dependencies" >> $GITHUB_STEP_SUMMARY
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
          else
            # Parse and display vulnerabilities
            if [ -s audit-report.json ] && jq empty audit-report.json 2>/dev/null; then
              pip-audit --format markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Count vulnerabilities
              vuln_count=$(jq '[.dependencies[] | select(.vulns | length > 0)] | length' audit-report.json 2>/dev/null || echo "0")
              
              if [ "$vuln_count" -gt "0" ]; then
                echo "âš ï¸ Found $vuln_count package(s) with vulnerabilities" >> $GITHUB_STEP_SUMMARY
                echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
                echo "VULN_COUNT=$vuln_count" >> $GITHUB_OUTPUT
                exit 1
              else
                echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
                echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ Error running pip-audit or parsing results" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-audit-report
          path: apps/backend/audit-report.json
          retention-days: 90

  npm-audit:
    name: NPM Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node
        with:
          node-version: '18.x'
          install-deps: 'true'

      - name: Run npm audit
        id: npm-audit
        run: |
          echo "## ðŸ”’ NPM Dependency Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only check production dependencies for high and critical vulnerabilities
          set +e
          npm audit --audit-level=high --production --json > npm-audit.json
          audit_exit=$?
          set -e
          
          if [ $audit_exit -eq 0 ]; then
            echo "âœ… No high or critical vulnerabilities found in NPM dependencies" >> $GITHUB_STEP_SUMMARY
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
          else
            # Parse audit results
            if [ -s npm-audit.json ] && jq empty npm-audit.json 2>/dev/null; then
              high=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json 2>/dev/null || echo "0")
              critical=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json 2>/dev/null || echo "0")
              
              if [ "$high" -gt "0" ] || [ "$critical" -gt "0" ]; then
                echo "âš ï¸ Found $critical critical and $high high severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                npm audit --audit-level=high --production >> $GITHUB_STEP_SUMMARY 2>&1 || true
                echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
                echo "VULN_COUNT=$((critical + high))" >> $GITHUB_OUTPUT
                exit 1
              else
                echo "âœ… No high or critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
                echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ npm audit failed or returned invalid output" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit.json
          retention-days: 90

  create-issue:
    name: Create Security Issue
    runs-on: ubuntu-latest
    needs: [python-audit, npm-audit]
    if: failure()

    steps:
      - name: Create or update security issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // Check for existing open security issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ðŸ”’ security,ðŸ“¦ dependencies,automated'
            });
            
            if (issues.data.length > 0) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `ðŸ”„ **New vulnerabilities detected**\n\nDate: ${new Date().toISOString()}\nWorkflow Run: ${runUrl}\n\nPlease review the latest scan results.`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Dependency Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
                body: `## Security Alert\n\nAutomated dependency scan has detected security vulnerabilities.\n\n### Action Required\n1. Review the [workflow run details](${runUrl})\n2. Download and review the audit reports\n3. Update affected dependencies\n4. Test thoroughly before deploying\n\n### Severity Thresholds\n- Python: All severities reported by pip-audit\n- NPM: High and Critical vulnerabilities only (production deps)\n\n### Recommended Actions\n- **Python**: Run \`pip-audit\` locally, review fixes, update pyproject.toml\n- **NPM**: Run \`npm audit fix\` to auto-fix compatible issues\n- Review breaking changes before upgrading major versions\n- Test all changes locally before pushing\n\n---\n*This issue was automatically created by the dependency-scan workflow.*`,
                labels: ['ðŸ”’ security', 'ðŸ“¦ dependencies', 'automated'],
                assignees: ['RbBtSn0w']
              });
            }

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs: [python-audit, npm-audit]

    steps:
      - name: Print summary
        run: |
          echo "## ðŸ“‹ Dependency Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python dependencies (pip-audit)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NPM dependencies (npm audit)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Severity Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "- **Python**: All vulnerabilities reported" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM**: High and Critical only (production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review individual scan results above" >> $GITHUB_STEP_SUMMARY
          echo "2. Download audit reports from artifacts" >> $GITHUB_STEP_SUMMARY
          echo "3. Address any identified vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "4. Update dependencies and test thoroughly" >> $GITHUB_STEP_SUMMARY
