name: Dependency Security Scan

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    # Weekly on Monday at 9:00 UTC (17:00 Beijing Time)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      fail-on-severity:
        description: 'Fail on vulnerability severity (low, moderate, high, critical)'
        required: false
        default: 'high'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical
  pull_request:
    paths:
      - 'apps/backend/pyproject.toml'
      - 'apps/backend/requirements.txt'
      - 'apps/frontend/package.json'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/dependency-scan.yml'

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  python-dependencies:
    name: Python Dependencies Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: apps/backend/pyproject.toml

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install backend dependencies
      working-directory: apps/backend
      run: |
        pip install -e .
        pip install pip-audit

    - name: Check for outdated packages
      id: outdated
      working-directory: apps/backend
      run: |
        echo "## ðŸ“¦ Outdated Python Packages" >> $GITHUB_STEP_SUMMARY
        pip list --outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Run pip-audit security check
      id: audit
      working-directory: apps/backend
      run: |
        echo "## ðŸ”’ Python Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run pip-audit and save results
        if pip-audit --format json --output audit_report.json --progress-spinner=off; then
          echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
        else
          # Check if we have valid JSON output
          if [ -s audit_report.json ] && jq empty audit_report.json 2>/dev/null; then
            # Show markdown output
            pip-audit --format markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count vulnerabilities
            vuln_count=$(jq '[.dependencies[] | select(.vulns | length > 0)] | length' audit_report.json 2>/dev/null || echo "0")
            
            if [ "$vuln_count" -gt "0" ]; then
              echo "âš ï¸ Found $vuln_count package(s) with vulnerabilities" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              echo "VULN_COUNT=$vuln_count" >> $GITHUB_OUTPUT
              
              # Fail on high/critical by default, configurable via input
              severity_threshold="${{ inputs.fail-on-severity || 'high' }}"
              echo "Severity threshold: $severity_threshold" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Error running pip-audit or invalid JSON output" >> $GITHUB_STEP_SUMMARY
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

    - name: Upload Python audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: python-dependency-report
        path: apps/backend/audit_report.json
        retention-days: 90

  npm-dependencies:
    name: NPM Dependencies Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for outdated packages
      id: outdated
      run: |
        echo "## ðŸ“¦ Outdated NPM Packages" >> $GITHUB_STEP_SUMMARY
        npm outdated >> $GITHUB_STEP_SUMMARY || echo "All packages are up to date" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Run npm audit
      id: npm_audit
      run: |
        echo "## ðŸ”’ NPM Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine audit level (default to high, allow override from input)
        audit_level="${{ inputs.fail-on-severity || 'high' }}"
        
        # Run npm audit for production dependencies only
        set +e
        npm audit --audit-level=$audit_level --production --json > npm_audit.json
        audit_exit_code=$?
        set -e
        
        if [ $audit_exit_code -eq 0 ]; then
          echo "âœ… No $audit_level or higher vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
        else
          # Parse results if valid JSON
          if [ -s npm_audit.json ] && jq empty npm_audit.json 2>/dev/null; then
            high=$(jq '.metadata.vulnerabilities.high // 0' npm_audit.json 2>/dev/null || echo "0")
            critical=$(jq '.metadata.vulnerabilities.critical // 0' npm_audit.json 2>/dev/null || echo "0")
            moderate=$(jq '.metadata.vulnerabilities.moderate // 0' npm_audit.json 2>/dev/null || echo "0")
            
            echo "ðŸ“Š **Vulnerability Summary:**" >> $GITHUB_STEP_SUMMARY
            echo "- Critical: $critical" >> $GITHUB_STEP_SUMMARY
            echo "- High: $high" >> $GITHUB_STEP_SUMMARY
            echo "- Moderate: $moderate" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$critical" -gt "0" ] || [ "$high" -gt "0" ]; then
              npm audit --audit-level=$audit_level --production >> $GITHUB_STEP_SUMMARY 2>&1 || true
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âœ… No $audit_level or higher vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ npm audit failed or returned invalid output (exit code: $audit_exit_code)" >> $GITHUB_STEP_SUMMARY
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Upload NPM audit report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: npm-dependency-report
        path: npm_audit.json
        retention-days: 90

  create-issue-on-failure:
    name: Create Issue if Vulnerabilities Found
    runs-on: ubuntu-latest
    needs: [python-dependencies, npm-dependencies]
    if: failure() && github.event_name == 'schedule'

    steps:
    - name: Create or update issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          // Check for existing open issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ðŸ”’ security,ðŸ“¦ dependencies,automated'
          });
          
          if (issues.data.length > 0) {
            // Update existing issue with comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `ðŸ”„ **New vulnerabilities detected**\n\nDate: ${new Date().toISOString()}\nWorkflow Run: ${runUrl}\n\nPlease review the latest scan results.`
            });
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Dependency Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: `## Security Alert\n\nAutomated dependency scan has detected security vulnerabilities.\n\n### Action Required\n1. Review the [workflow run details](${runUrl})\n2. Download and review the security reports\n3. Update affected dependencies\n4. Test thoroughly before deploying\n\n### Recommended Actions\n- For Python: Run \`pip-audit\` locally to identify fixes\n- For NPM: Run \`npm audit fix\` to auto-fix compatible issues\n- Review breaking changes before upgrading major versions\n\n---\n*This issue was automatically created by the dependency scan workflow.*`,
              labels: ['ðŸ”’ security', 'ðŸ“¦ dependencies', 'automated'],
              assignees: ['RbBtSn0w']
            });
          }

  summary:
    name: Scan Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs: [python-dependencies, npm-dependencies]

    steps:
    - name: Print Summary
      run: |
        echo "## ðŸ“‹ Dependency Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Scans Performed:**" >> $GITHUB_STEP_SUMMARY
        echo "- Python dependencies security audit (pip-audit)" >> $GITHUB_STEP_SUMMARY
        echo "- NPM dependencies security audit (npm audit)" >> $GITHUB_STEP_SUMMARY
        echo "- Outdated package detection" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Œ **Policy:**" >> $GITHUB_STEP_SUMMARY
        echo "- Fails on: High and Critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- Reports only: Low and Moderate vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Œ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review uploaded dependency reports in Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Check for critical security updates" >> $GITHUB_STEP_SUMMARY
        echo "3. Create PRs for dependency updates" >> $GITHUB_STEP_SUMMARY
        echo "4. Test thoroughly before merging" >> $GITHUB_STEP_SUMMARY
