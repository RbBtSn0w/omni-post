name: Auto-enable auto-merge for Dependabot security PRs

on:
  pull_request:
    types: [opened, labeled, reopened, synchronize]

jobs:
  enable-auto-merge:
    # Only proceed for Dependabot actors
    if: >
      github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Check if PR is a security update
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = (pr.labels || []).map(l => l.name.toLowerCase());
            const isSecurityLabel = labels.includes('security') || /security/i.test(pr.title || '') || /security/i.test(pr.body || '');
            return isSecurityLabel;

      - name: Enable GitHub auto-merge on this PR (rebase)
        if: steps.check.outputs.result == 'true'
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          merge-method: rebase
          pull-request-number: ${{ github.event.pull_request.number }}
