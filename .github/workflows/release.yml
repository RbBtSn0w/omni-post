name: Auto Release

# Automatically creates a GitHub Release when a version tag is pushed.
# Usage: git tag v1.0.0 && git push origin v1.0.0

on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v2.1.3, etc.

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for changelog generation

    - name: Get tag info
      id: tag
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

        # Get previous tag for changelog
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

        # Determine if this is a prerelease
        if [[ "$TAG_NAME" == *"-"* ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi

        echo "## ðŸ“‹ Tag Info" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous Tag**: ${PREV_TAG:-None}" >> $GITHUB_STEP_SUMMARY
        echo "- **Prerelease**: $(if [[ \"$TAG_NAME\" == *\"-\"* ]]; then echo Yes; else echo No; fi)" >> $GITHUB_STEP_SUMMARY

    - name: Generate changelog
      id: changelog
      run: |
        TAG_NAME="${{ steps.tag.outputs.tag_name }}"
        PREV_TAG="${{ steps.tag.outputs.prev_tag }}"

        # Generate changelog content
        {
          echo "changelog<<EOF"

          if [ -n "$PREV_TAG" ]; then
            echo "## What's Changed"
            echo ""

            # Features
            FEATURES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^feat" --grep="^feature" -i 2>/dev/null || true)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ New Features"
              echo "$FEATURES"
              echo ""
            fi

            # Bug fixes
            FIXES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^fix" -i 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            # All other changes
            echo "### ðŸ“ All Changes"
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h) by @%an" --no-merges | head -50
            echo ""

            # Contributors
            echo ""
            echo "### ðŸ‘¥ Contributors"
            git log $PREV_TAG..HEAD --pretty=format:"%an" --no-merges | sort -u | while read name; do
              echo "- $name"
            done
          else
            echo "## ðŸŽ‰ Initial Release"
            echo ""
            echo "This is the first release of OmniPost!"
            echo ""
            echo "### Recent Changes"
            git log --pretty=format:"- %s (%h)" --no-merges -n 30
          fi

          echo ""
          echo "---"
          echo ""
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG:-$(git rev-list --max-parents=0 HEAD | head -1)}...$TAG_NAME"

          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: Release ${{ steps.tag.outputs.tag_name }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: ${{ steps.tag.outputs.is_prerelease }}
        generate_release_notes: false  # We generate our own
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… Release Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release**: [${{ steps.tag.outputs.tag_name }}](https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY
