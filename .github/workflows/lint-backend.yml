name: Backend Lint

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/lint-backend.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/lint-backend.yml'

jobs:
  lint:
    name: Python Code Quality
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort pylint radon

    - name: Check code formatting with black
      run: |
        cd apps/backend
        black --check src/ --line-length=100
      continue-on-error: true

    - name: Check import sorting with isort
      run: |
        cd apps/backend
        isort --check-only src/ --profile black
      continue-on-error: true

    - name: Lint with flake8
      run: |
        cd apps/backend
        flake8 src/ --max-line-length=100 --extend-ignore=E203,W503
      continue-on-error: true

    - name: Lint with pylint
      run: |
        cd apps/backend
        pip install -e .
        pylint src/ --disable=all --enable=E,F --exit-zero || true
      continue-on-error: true

    - name: Check code duplication
      run: |
        cd apps/backend
        pylint --disable=all --enable=duplicate-code src/ || true
      continue-on-error: true

    - name: Analyze Python complexity
      run: |
        cd apps/backend
        echo "=== Cyclomatic Complexity ==="
        radon cc src/ -a --total-average || true
        echo ""
        echo "=== Maintainability Index ==="
        radon mi src/ || true
      continue-on-error: true

    - name: Count lines of code
      run: |
        echo "=== Backend ==="
        find apps/backend/src -name "*.py" | xargs wc -l | tail -1

    - name: Report lint results
      if: always()
      run: |
        echo "Lint checks completed. Review the results above."
