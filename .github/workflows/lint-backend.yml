name: Backend Lint

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/lint-backend.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/lint-backend.yml'

permissions:
  contents: read

jobs:
  lint:
    name: Python Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python environment
      uses: ./.github/actions/setup-python
      with:
        python-version: '3.10'
        install-deps: 'false'

    - name: Install linting tools
      run: pip install black flake8 isort pylint radon

    - name: Check code formatting with black
      id: black
      working-directory: apps/backend
      run: |
        black --check src/ --line-length=100
      # Black is a hard gate - code must be properly formatted

    - name: Check import sorting with isort
      id: isort
      working-directory: apps/backend
      run: |
        isort --check-only src/ --profile black
      # isort is a hard gate - imports must be properly sorted

    - name: Lint with flake8
      id: flake8
      working-directory: apps/backend
      run: |
        flake8 src/ --max-line-length=100 --extend-ignore=E203,W503
      continue-on-error: true

    - name: Lint with pylint
      id: pylint
      working-directory: apps/backend
      run: |
        pip install -e .
        pylint src/ --disable=all --enable=E,F --exit-zero
      continue-on-error: true

    - name: Check code duplication
      id: duplication
      working-directory: apps/backend
      run: |
        pylint --disable=all --enable=duplicate-code src/ --exit-zero
      continue-on-error: true

    - name: Analyze Python complexity
      id: complexity
      working-directory: apps/backend
      run: |
        echo "=== Cyclomatic Complexity ===" >> $GITHUB_STEP_SUMMARY
        radon cc src/ -a --total-average >> $GITHUB_STEP_SUMMARY || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "=== Maintainability Index ===" >> $GITHUB_STEP_SUMMARY
        radon mi src/ >> $GITHUB_STEP_SUMMARY || true
      continue-on-error: true

    - name: Count lines of code
      run: |
        echo "=== Backend ===" >> $GITHUB_STEP_SUMMARY
        find apps/backend/src -name "*.py" | xargs wc -l | tail -1 >> $GITHUB_STEP_SUMMARY

    - name: Summarize lint results
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Lint Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.black.outcome }}" == "failure" ]; then
          echo "âŒ **Black**: Formatting issues detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Black**: Passed" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ steps.isort.outcome }}" == "failure" ]; then
          echo "âŒ **isort**: Import sorting issues detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **isort**: Passed" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ steps.flake8.outcome }}" == "failure" ]; then
          echo "âŒ **flake8**: Linting issues detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **flake8**: Passed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Review the step outputs above for details." >> $GITHUB_STEP_SUMMARY
