name: Dependency Security Check

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    # Weekly on Monday at 9:00 UTC (17:00 Beijing Time)
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:
  # Run on PRs that modify dependency files
  pull_request:
    paths:
      - 'apps/backend/requirements.txt'
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  python-dependencies:
    name: Python Dependencies Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: apps/backend/pyproject.toml

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install backend dependencies
      working-directory: apps/backend
      run: |
        pip install -r requirements.txt
        pip install pip-audit

    - name: Check for outdated packages
      id: outdated
      working-directory: apps/backend
      run: |
        echo "=== Outdated Python Packages ===" >> $GITHUB_STEP_SUMMARY
        pip list --outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Run pip-audit security check
      id: audit
      working-directory: apps/backend
      run: |
        echo "## ðŸ”’ Python Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run pip-audit and save results (exit code 0 = no vulns, 1 = vulns found)
        if pip-audit --format json --output audit_report.json --progress-spinner=off; then
          echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
        else
          # Non-zero exit: either vulnerabilities found or error occurred
          if [ -s audit_report.json ] && jq empty audit_report.json 2>/dev/null; then
            # Valid JSON exists, show markdown output
            pip-audit --format markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count packages with vulnerabilities
            vuln_count=$(jq '[.dependencies[] | select(.vulns | length > 0)] | length' audit_report.json 2>/dev/null || echo "0")
            if [ "$vuln_count" -gt "0" ]; then
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              echo "VULN_COUNT=$vuln_count" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Error running pip-audit or invalid JSON output" >> $GITHUB_STEP_SUMMARY
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

    - name: Upload Python report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: python-dependency-report
        path: apps/backend/audit_report.json
        retention-days: 90

  npm-dependencies:
    name: NPM Dependencies Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        # No npm cache - platform-specific deps cause issues

    - name: Install dependencies
      run: npm install

    - name: Run npm audit
      id: npm_audit
      continue-on-error: true
      run: |
        echo "## ðŸ”’ NPM Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Only check production dependencies for high and critical vulnerabilities
        # npm audit returns: 0 = no vulns, non-zero = vulns or error
        set +e  # Don't exit on error
        npm audit --audit-level=high --production --json > npm_audit.json
        audit_exit_code=$?
        set -e
        
        if [ $audit_exit_code -eq 0 ]; then
          echo "âœ… No high or critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
        else
          # Check if output is valid JSON
          if [ -s npm_audit.json ] && jq empty npm_audit.json 2>/dev/null; then
            # Valid JSON, parse vulnerability counts
            high=$(jq '.metadata.vulnerabilities.high // 0' npm_audit.json 2>/dev/null || echo "0")
            critical=$(jq '.metadata.vulnerabilities.critical // 0' npm_audit.json 2>/dev/null || echo "0")
            
            if [ "$high" -gt "0" ] || [ "$critical" -gt "0" ]; then
              echo "âš ï¸ Found $critical critical and $high high severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              npm audit --audit-level=high --production >> $GITHUB_STEP_SUMMARY 2>&1 || true
              echo "VULNERABILITIES_FOUND=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âœ… No high or critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
            fi
          else
            # Invalid JSON or error
            echo "âš ï¸ npm audit failed or returned invalid output (exit code: $audit_exit_code)" >> $GITHUB_STEP_SUMMARY
            if [ -s npm_audit.json ]; then
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              head -20 npm_audit.json >> $GITHUB_STEP_SUMMARY 2>&1 || true
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_OUTPUT
          fi
        fi

  critical-updates:
    name: Check Critical Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Check Playwright version
      working-directory: apps/backend
      run: |
        python -c "
        import pkg_resources
        try:
          playwright_version = pkg_resources.get_distribution('playwright').version
          print(f'ðŸ“¦ Current Playwright version: {playwright_version}')
          print('âš ï¸ Note: Playwright requires regular updates to support browser versions')
        except:
          print('âš ï¸ Playwright not installed')
        " >> $GITHUB_STEP_SUMMARY

    - name: Check Flask version
      working-directory: apps/backend
      run: |
        python -c "
        import pkg_resources
        try:
          flask_version = pkg_resources.get_distribution('flask').version
          print(f'ðŸ“¦ Current Flask version: {flask_version}')
        except:
          print('âš ï¸ Flask not installed')
        " >> $GITHUB_STEP_SUMMARY

    - name: Check Vue version
      run: |
        if [ -f "apps/frontend/package.json" ]; then
          echo "ðŸ“¦ Frontend Dependencies:" >> $GITHUB_STEP_SUMMARY
          grep -E '"vue"|"vite"|"@vitejs"' apps/frontend/package.json >> $GITHUB_STEP_SUMMARY || true
        fi

  create-issue:
    name: Create Issue if Vulnerabilities Found
    runs-on: ubuntu-latest
    needs: [python-dependencies, npm-dependencies]
    if: failure()

    steps:
    - name: Create detailed issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          // Check if there's already an open issue with these labels
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ðŸ”’ security,ðŸ“¦ dependencies,automated'
          });
          
          // If an issue exists, add a comment instead of creating a new one
          if (issues.data.length > 0) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `ðŸ”„ **New vulnerabilities detected**\n\nDate: ${new Date().toISOString()}\nWorkflow Run: ${runUrl}\n\nPlease review the latest scan results.`
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Dependency Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: `## Security Alert\n\nAutomated dependency check has detected security vulnerabilities.\n\n### Action Required\n1. Review the [workflow run details](${runUrl})\n2. Download and review the security reports\n3. Update affected dependencies\n4. Test thoroughly before deploying\n\n### Recommended Actions\n- For Python: Run \`pip-audit\` locally to identify fixes\n- For NPM: Run \`npm audit fix\` to auto-fix compatible issues\n- Review breaking changes before upgrading major versions\n\n---\n*This issue was automatically created by the dependency check workflow.*`,
              labels: ['ðŸ”’ security', 'ðŸ“¦ dependencies', 'automated'],
              assignees: ['RbBtSn0w']
            });
          }

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs: [python-dependencies, npm-dependencies, critical-updates]

    steps:
    - name: Print Summary
      run: |
        echo "## ðŸ“‹ Dependency Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Checks Performed:**" >> $GITHUB_STEP_SUMMARY
        echo "- Python dependencies audit" >> $GITHUB_STEP_SUMMARY
        echo "- NPM dependencies audit (monorepo)" >> $GITHUB_STEP_SUMMARY
        echo "- Critical dependencies version check" >> $GITHUB_STEP_SUMMARY
        echo "- Security vulnerability scan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Œ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the uploaded dependency reports" >> $GITHUB_STEP_SUMMARY
        echo "2. Check for critical security updates" >> $GITHUB_STEP_SUMMARY
        echo "3. Create PRs for outdated dependencies" >> $GITHUB_STEP_SUMMARY
        echo "4. Test thoroughly before merging" >> $GITHUB_STEP_SUMMARY
