name: Dependency Security Check

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    # Weekly on Monday at 9:00 UTC (17:00 Beijing Time)
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  python-dependencies:
    name: Python Dependencies Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: apps/backend/pyproject.toml

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install backend dependencies
      working-directory: apps/backend
      run: |
        pip install -r requirements.txt
        pip install safety

    - name: Check for outdated packages
      id: outdated
      working-directory: apps/backend
      run: |
        echo "=== Outdated Python Packages ===" >> $GITHUB_STEP_SUMMARY
        pip list --outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Run safety check
      id: safety
      working-directory: apps/backend
      run: |
        echo "=== Python Security Check ===" >> $GITHUB_STEP_SUMMARY
        safety check --json > safety_report.json || true
        if grep -q "vulnerabilities" safety_report.json; then
          echo "âš ï¸ Security vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
          cat safety_report.json >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Python report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: python-dependency-report
        path: apps/backend/safety_report.json
        retention-days: 30

  npm-dependencies:
    name: NPM Dependencies Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies (monorepo)
      run: npm install

    - name: Audit all dependencies
      id: audit
      run: |
        echo "=== NPM Dependencies Audit ===" >> $GITHUB_STEP_SUMMARY
        npm audit --audit-level=moderate 2>&1 >> $GITHUB_STEP_SUMMARY || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "=== Outdated Packages ===" >> $GITHUB_STEP_SUMMARY
        npm outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY

  critical-updates:
    name: Check Critical Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Check Playwright version
      working-directory: apps/backend
      run: |
        python -c "
        import pkg_resources
        try:
          playwright_version = pkg_resources.get_distribution('playwright').version
          print(f'ðŸ“¦ Current Playwright version: {playwright_version}')
          print('âš ï¸ Note: Playwright requires regular updates to support browser versions')
        except:
          print('âš ï¸ Playwright not installed')
        " >> $GITHUB_STEP_SUMMARY

    - name: Check Flask version
      working-directory: apps/backend
      run: |
        python -c "
        import pkg_resources
        try:
          flask_version = pkg_resources.get_distribution('flask').version
          print(f'ðŸ“¦ Current Flask version: {flask_version}')
        except:
          print('âš ï¸ Flask not installed')
        " >> $GITHUB_STEP_SUMMARY

    - name: Check Vue version
      run: |
        if [ -f "apps/frontend/package.json" ]; then
          echo "ðŸ“¦ Frontend Dependencies:" >> $GITHUB_STEP_SUMMARY
          grep -E '"vue"|"vite"|"@vitejs"' apps/frontend/package.json >> $GITHUB_STEP_SUMMARY || true
        fi

  create-issue:
    name: Create Issue if Vulnerabilities Found
    runs-on: ubuntu-latest
    needs: [python-dependencies, npm-dependencies]
    if: failure()

    steps:
    - name: Create issue for vulnerabilities
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Dependency Vulnerabilities Detected',
            body: 'Security Alert: Automated dependency check has detected security vulnerabilities or critical updates.\n\nAction Required:\n- Review the workflow run details\n- Check the uploaded dependency reports\n- Address vulnerabilities with priority\n\nCritical Dependencies to Monitor:\n- Playwright - Browser automation core\n- Flask - Web framework\n- Vue 3 - Frontend framework\n- SQLite3 - Database driver\n\nNote: This is an automated check. Review carefully before updating.',
            labels: ['ðŸ”’ security', 'ðŸ“¦ dependencies', 'automated']
          })

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs: [python-dependencies, npm-dependencies, critical-updates]

    steps:
    - name: Print Summary
      run: |
        echo "## ðŸ“‹ Dependency Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Checks Performed:**" >> $GITHUB_STEP_SUMMARY
        echo "- Python dependencies audit" >> $GITHUB_STEP_SUMMARY
        echo "- NPM dependencies audit (monorepo)" >> $GITHUB_STEP_SUMMARY
        echo "- Critical dependencies version check" >> $GITHUB_STEP_SUMMARY
        echo "- Security vulnerability scan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Œ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the uploaded dependency reports" >> $GITHUB_STEP_SUMMARY
        echo "2. Check for critical security updates" >> $GITHUB_STEP_SUMMARY
        echo "3. Create PRs for outdated dependencies" >> $GITHUB_STEP_SUMMARY
        echo "4. Test thoroughly before merging" >> $GITHUB_STEP_SUMMARY
